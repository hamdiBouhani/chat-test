<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <title>Test, WebSocket!</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <!-- import moment-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"
        integrity="sha256-AdQN98MVZs44Eq2yTwtoKufhnU+uZ7v2kXnD5vqzZVo=" crossorigin="anonymous"></script>
</head>

<body>

    <div class="container-sm">
        <div class="input-group">
            Token : <input id="token" type="text" class="form-control" name="tokenName" autocomplete="on">
            Org_id : <input id="org_id" type="text" class="form-control" name="orgIdName">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Close connection</button>
        </div>

        <br>
        <hr />
        <br>

        <pre id="output"></pre>

        <br>
        <hr />
        <br>

        <div>
            Timer : <span id="chronotime">0:00:00</span> <br> <br>
        </div>
        <form name="chronoForm">
            <input type="button" name="startstop" value="start!" onClick="chronoStart()" />
            <input type="button" name="reset" value="reset!" onClick="chronoReset()" />
        </form>

    </div>
    <script>

        var socket = null;

        function connect() {
            var token = document.getElementById("token").value;
            var org_id = document.getElementById("org_id").value;
            var url = "ws://localhost:8080/ws?access_token=" + token + "&org_id=" + org_id;

            console.log(url);

            socket = new WebSocket(url);

            socket.onopen = function () {
                output.innerHTML += "<div class=\"row\"> <div class=\"col\"> <p> Connected </p> </div></div>";
            };

            socket.onmessage = function (e) {
                output.innerHTML += "<div class=\"row\"> <div class=\"col\">" +
                    prettifyJson(e.data, true) +
                    "</div></div>";
            };

            socket.onclose = () => {
                console.log('Web Socket Connection Closed');
            };
        }

        function disconnect() {
            if (socket != null) {
                socket.close();
            }

        }

        function prettifyJson(json, prettify) {
            if (typeof json !== 'string') {
                if (prettify) {
                    json = JSON.stringify(json, undefined, 4);
                } else {
                    json = JSON.stringify(json);
                }
            }
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                function (match) {
                    let cls = "<span>";
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = "<span class='text-danger'>";
                        } else {
                            cls = "<span>";
                        }
                    } else if (/true|false/.test(match)) {
                        cls = "<span class='text-primary'>";
                    } else if (/null/.test(match)) {
                        cls = "<span class='text-info'>";
                    }
                    return cls + match + "</span>";
                }
            );
        }

        // Testing start/stop code

        var startTime = 0;
        var start = 0;
        var end = 0;
        var diff = 0;
        var timerID = 0;

        function chrono() {
            end = new Date();
            diff = end - start;
            diff = new Date(diff);

            var sec = diff.getSeconds();
            var min = diff.getMinutes();
            var hr = diff.getHours() - 1;
            if (min < 10) {
                min = "0" + min
            }
            if (sec < 10) {
                sec = "0" + sec
            }

            document.getElementById("chronotime").innerHTML = hr + ":" + min + ":" + sec;
            timerID = setTimeout("chrono()", 10)
        }

        var resultId;

        function sendPostRequest() {
            var time = moment().utc();

            const dataAsText =
            {
                "workspace_id": "212", // hard coded just for testing purpose
                "stream_title": "",
                "task_id": "1",
                "task_name": "fooo",
                "description": "contuning working on t1",
                "start_time": time,
            };

            data = JSON.stringify(dataAsText);
            org_id = document.getElementById("org_id").value;
            token = document.getElementById("token").value;
            const postUrl = "http://localhost:8080/api/v1/organizations/" + org_id + "/time-entries";
            $.ajax({
                url: postUrl,
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                data: data,
                success: function (result) {
                    console.log(result);
                    resultId = result.data.id;
                },
                error: function (error) {
                    console.log(error);
                }
            });


        }

        function chronoStart() {
            // socket thingy
            if (!socket) {
                return false;
            }
            // I sh'd send an http Put Request to
            sendPostRequest();
            // display thingy
            document.chronoForm.startstop.value = "stop!";
            document.chronoForm.startstop.onclick = chronoStop;
            document.chronoForm.reset.onclick = chronoReset;
            start = new Date();
            chrono()
        }

        function chronoContinue() {
            sendPostRequest();
            document.chronoForm.startstop.value = "stop!";
            document.chronoForm.startstop.onclick = chronoStop;
            document.chronoForm.reset.onclick = chronoReset;
            start = new Date() - diff;
            start = new Date(start);
            chrono()
        }

        function chronoReset() {
            document.getElementById("chronotime").innerHTML = "0:00:00";
            start = new Date();
        }

        function chronoStopReset() {
            document.getElementById("chronotime").innerHTML = "0:00:00";
            document.chronoForm.startstop.onclick = chronoStart;
        }

        function chronoStop() {
            sendStopRequest();
            document.chronoForm.startstop.value = "start!";
            document.chronoForm.startstop.onclick = chronoContinue;
            document.chronoForm.reset.onclick = chronoStopReset;
            clearTimeout(timerID)
        }


        function sendStopRequest() {
            var time = moment().utc();
            const dataAsText =
            {
                "stop_time": time
            };

            data = JSON.stringify(dataAsText);
            org_id = document.getElementById("org_id").value;
            token = document.getElementById("token").value;
            const postUrl = "http://localhost:8080/api/v1/organizations/" + org_id + "/time-entries/" + resultId + "/stop";
            $.ajax({
                url: postUrl,
                type: 'PUT',
                contentType: 'application/json',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                data: data,
                success: function (result) {
                    console.log(result);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }


    </script>
</body>

</html>